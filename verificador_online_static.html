<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EPL — Verificação de Viaturas</title>
<style>
:root { --ok:#27ae60; --warn:#f1c40f; --bad:#e74c3c; --ink:#1b1f23; --muted:#6a737d; }
* { box-sizing: border-box; }
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; color: var(--ink); }
header { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
header img { height:60px; }
h2 { margin: 6px 0; }
.search { display:flex; gap:8px; margin: 8px 0 18px; }
input[type="search"] { flex:1; padding:12px; font-size:16px; border:1px solid #ddd; border-radius:10px; }
.btn { padding:10px 14px; border:1px solid #ddd; border-radius:10px; background:#f8f9fa; cursor:pointer; }
.card { border:1px solid #e5e7eb; border-radius:14px; padding:14px; margin:10px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
.row { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
.badge { display:inline-block; padding:6px 10px; border-radius:999px; color:#fff; font-weight:600; font-size:13px; }
.ativo { background: var(--ok); }
.restrito { background: var(--warn); color:#111; }
.suspenso { background: var(--bad); }
small { color: var(--muted); }
.meta { display:flex; gap:12px; flex-wrap:wrap; }
.meta div { background:#f8f9fa; padding:6px 10px; border-radius:8px; }
.photo { max-height:120px; border-radius:12px; border:1px solid #eee; }
footer { margin-top: 24px; color: var(--muted); font-size: 12px; }
</style>
</head>
<body>
<header>
  <img src="https://raw.githubusercontent.com/mondeja/openai-assets/main/epluanda_logo.jpg" alt="EPL Logo">
  <h2>EPL — Verificação de Viaturas</h2>
</header>

<div class="search">
  <input id="q" type="search" placeholder="Ler QR / procurar por ID ou Matrícula">
  <button id="btn" class="btn">Pesquisar</button>
</div>
<div id="content">A carregar…</div>

<footer>Se o estado for <b>SUSPENSO</b> ou <b>expirado</b>, negar entrada e contactar a secretaria.</footer>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbwlHapLjX_rokPM86dtcG4_Nb61Y5aesJtxbRDrVoO0Qx2JtkeANuZrfed8dmRCJfM/exec"; 
const norm = s => (s||'').toString().toUpperCase();
const badge = e => e.includes('ATIV')?'ativo':(e.includes('RESTR')?'restrito':'suspenso');

function carCard(r) {
  const estado = norm(r.estado||'');
  const foto = r.foto_url_direct || r.foto_url || '';
  const validade = r.acesso_fim||'—';
  const carro = [r.marca,r.modelo,r.cor].filter(Boolean).join(' ');
  return `
    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:700;font-size:16px">ID: ${r.vehicle_id||'—'} | Matrícula: ${r.matricula||'—'}</div>
          <div><span class="badge ${badge(estado)}">${r.estado||'—'}</span> <small>Validade: ${validade}</small></div>
        </div>
        ${foto ? `<img class="photo" src="${foto}" alt="foto">` : ''}
      </div>
      <div class="meta">
        <div><b>Condutor:</b> ${r.condutor_nome||'—'}</div>
        <div><b>Veículo:</b> ${carro||'—'}</div>
        <div><b>Zona:</b> ${r.zona_estacionamento||'—'}</div>
        ${r.dias_autorizados?`<div><b>Dias:</b> ${r.dias_autorizados}</div>`:''}
        ${r.hora_janela?`<div><b>Horário:</b> ${r.hora_janela}</div>`:''}
        ${r.contacto?`<div><b>Contacto:</b> ${r.contacto}</div>`:''}
      </div>
      ${r.observacoes?`<p><small>${r.observacoes}</small></p>`:''}
    </div>`;
}

function render(list) {
  const host = document.getElementById('content');
  if (!list || !list.length) { host.innerHTML = '<p>Sem resultados.</p>'; return; }
  host.innerHTML = list.map(carCard).join('');
}

async function queryApi(q) {
  const url = new URL(API_BASE);
  url.searchParams.set('fmt','json');
  if (q) url.searchParams.set('id', q);
  const res = await fetch(url.toString(), { cache: 'no-store' });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error||'Erro');
  return data.results || [];
}

async function boot() {
  try {
    const p = new URLSearchParams(location.search);
    const q = p.get('id') || p.get('q') || '';
    if (q) document.getElementById('q').value = q;
    const results = await queryApi(q);
    render(results);
  } catch (e) {
    document.getElementById('content').innerHTML = '<p>Erro a carregar: '+e.message+'</p>';
  }
}

document.getElementById('btn').addEventListener('click', async () => {
  const q = document.getElementById('q').value.trim();
  const results = await queryApi(q);
  render(results);
});
document.getElementById('q').addEventListener('keydown', ev => { if (ev.key==='Enter') document.getElementById('btn').click(); });
boot();
</script>
</body>
</html>
